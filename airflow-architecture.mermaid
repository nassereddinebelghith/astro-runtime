flowchart TB
    subgraph External["ğŸŒ External Access"]
        User["ğŸ‘¤ User"]
        Browser["ğŸŒ Web Browser"]
    end

    subgraph Kubernetes["â˜¸ï¸ Kubernetes Cluster"]
        
        subgraph Ingress["ğŸ”€ Ingress Layer"]
            IngressController["ğŸ“¡ Ingress Controller<br/><small>airflow.example.com</small>"]
        end
        
        subgraph PreLoginLayer["ğŸ¨ Pre-Login Layer"]
            PreLoginSvc["âš™ï¸ Service: prelogin<br/><small>ClusterIP:8080</small>"]
            
            subgraph PreLoginPod["ğŸ“¦ Pre-Login Pod"]
                Nginx["ğŸ”§ Nginx<br/><small>Port 8080</small>"]
                StaticHTML["ğŸ“„ index.html<br/><small>Static branding page</small>"]
                NginxConfig["âš™ï¸ nginx.conf<br/><small>- Serves / â†’ index.html<br/>- Serves /assets/ â†’ static files<br/>- Proxy /* â†’ Airflow webserver</small>"]
            end
        end
        
        subgraph AirflowLayer["âœˆï¸ Airflow 3.1.4 Layer"]
            WebSvc["âš™ï¸ Service: airflow-webserver<br/><small>ClusterIP:8080</small>"]
            
            subgraph WebPod["ğŸ“¦ Airflow Webserver Pod"]
                AirflowWeb["ğŸŒ Airflow Webserver<br/><small>v3.1.4 (Astronomer Runtime)</small>"]
                CustomAuthManager["ğŸ” Custom Auth Manager<br/><small>Keycloak OIDC</small>"]
                RoleMapper["ğŸ—ºï¸ Role Mapping Logic<br/><small>Environment variable:<br/>ROLE_MAPPING</small>"]
            end
        end
    end
    
    subgraph Keycloak["ğŸ”‘ Keycloak (OIDC Provider)"]
        KeycloakServer["ğŸ” Keycloak Server<br/><small>Identity Provider</small>"]
        KeycloakGroups["ğŸ‘¥ LDAP/Keycloak Groups"]
    end
    
    %% Authentication Flow
    User -->|"1ï¸âƒ£ HTTPS Access"| Browser
    Browser -->|"2ï¸âƒ£ GET /"| IngressController
    IngressController -->|"3ï¸âƒ£ Route to prelogin"| PreLoginSvc
    PreLoginSvc -->|"4ï¸âƒ£"| Nginx
    
    Nginx -->|"5ï¸âƒ£ Serve static page"| StaticHTML
    StaticHTML -.->|"6ï¸âƒ£ HTML page displayed"| Browser
    
    Browser -->|"7ï¸âƒ£ Click 'Login'<br/>Redirect to /login"| IngressController
    IngressController -->|"8ï¸âƒ£"| PreLoginSvc
    PreLoginSvc -->|"9ï¸âƒ£"| Nginx
    
    Nginx -->|"ğŸ”Ÿ Proxy to Airflow"| WebSvc
    WebSvc -->|"1ï¸âƒ£1ï¸âƒ£"| AirflowWeb
    
    AirflowWeb -->|"1ï¸âƒ£2ï¸âƒ£ Detect unauthenticated user<br/>Initiate OIDC flow"| CustomAuthManager
    CustomAuthManager -->|"1ï¸âƒ£3ï¸âƒ£ Redirect to /oauth/authorize"| KeycloakServer
    
    KeycloakServer -.->|"1ï¸âƒ£4ï¸âƒ£ Keycloak login page"| Browser
    Browser -->|"1ï¸âƒ£5ï¸âƒ£ Credentials"| KeycloakServer
    
    KeycloakServer -->|"1ï¸âƒ£6ï¸âƒ£ Callback with auth code<br/>/oauth-authorized"| CustomAuthManager
    CustomAuthManager -->|"1ï¸âƒ£7ï¸âƒ£ Exchange code for tokens"| KeycloakServer
    KeycloakServer -->|"1ï¸âƒ£8ï¸âƒ£ Access Token + ID Token<br/>(contains user groups)"| CustomAuthManager
    
    CustomAuthManager -->|"1ï¸âƒ£9ï¸âƒ£ Extract groups<br/>from token"| RoleMapper
    KeycloakGroups -.->|"Groups included<br/>in token"| CustomAuthManager
    
    RoleMapper -->|"2ï¸âƒ£0ï¸âƒ£ Map group â†’ Airflow role<br/><small>Admin, Op, Viewer, User, Public</small>"| AirflowWeb
    
    AirflowWeb -.->|"2ï¸âƒ£1ï¸âƒ£ Session created<br/>Redirect to /home"| Browser
    Browser -.->|"2ï¸âƒ£2ï¸âƒ£ Access granted per role"| AirflowWeb

    %% Styles
    classDef userStyle fill:#e1f5ff,stroke:#01579b,stroke-width:2px,color:#000
    classDef ingressStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef preloginStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef airflowStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef keycloakStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    classDef componentStyle fill:#fff,stroke:#666,stroke-width:1px,color:#000
    
    class User,Browser userStyle
    class IngressController ingressStyle
    class PreLoginSvc,Nginx,StaticHTML,NginxConfig preloginStyle
    class WebSvc,AirflowWeb,CustomAuthManager,RoleMapper airflowStyle
    class KeycloakServer,KeycloakGroups keycloakStyle
