apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-prelogin-config
  namespace: airflow
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        upstream airflow {
            # IMPORTANT: Remplace par ton vrai service Airflow
            # Exemples possibles:
            # - astronomer-webserver.airflow.svc.cluster.local:8080
            # - airflow-webserver:8080
            server astronomer-webserver:8080;
        }

        server {
            listen 80;
            server_name _;

            # Intercepte les 401 et sert la landing page
            error_page 401 = @landing_page;

            location @landing_page {
                root /usr/share/nginx/html;
                try_files /index.html =404;
            }

            # Proxy TOUT vers Airflow
            location / {
                proxy_pass http://airflow;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                
                proxy_redirect off;
                proxy_buffering off;
                
                # CRITIQUE: Intercepte les erreurs
                proxy_intercept_errors on;
            }
        }
    }

  index.html: |
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Apache Airflow - Authentification</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #017CEE 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .container {
                background: white;
                border-radius: 20px;
                padding: 60px 80px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 500px;
            }
            .logo {
                font-size: 64px;
                margin-bottom: 20px;
            }
            h1 {
                font-size: 32px;
                color: #1a1a1a;
                margin-bottom: 10px;
            }
            .subtitle {
                font-size: 16px;
                color: #666;
                margin-bottom: 40px;
            }
            .login-btn {
                background: linear-gradient(135deg, #017CEE 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 16px 50px;
                font-size: 18px;
                font-weight: 600;
                border-radius: 50px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 15px rgba(1, 124, 238, 0.3);
            }
            .login-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(1, 124, 238, 0.4);
            }
            .security-note {
                margin-top: 30px;
                font-size: 14px;
                color: #999;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="logo">ðŸš€</div>
            <h1>Apache Airflow</h1>
            <p class="subtitle">Plateforme de Data Orchestration</p>
            
            <a href="/login" class="login-btn">
                Se connecter via SSO
            </a>
            
            <p class="security-note">
                ðŸ”’ Authentification sÃ©curisÃ©e via Keycloak
            </p>
        </div>
    </body>
    </html>
