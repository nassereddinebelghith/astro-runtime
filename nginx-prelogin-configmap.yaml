{{- if .Values.nginx.prelogin.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "astronomer.fullname" . }}-nginx-prelogin
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "astronomer.labels" . | nindent 4 }}
    component: nginx-prelogin
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        upstream airflow {
            # Service Airflow webserver
            server {{ include "astronomer.fullname" . }}-webserver:{{ .Values.ports.airflowUI }};
        }

        server {
            listen 80;
            server_name _;

            # Intercepte les 401 et sert la landing page
            error_page 401 = @landing_page;

            location @landing_page {
                root /usr/share/nginx/html;
                try_files /index.html =404;
            }

            # Proxy TOUT vers Airflow
            location / {
                proxy_pass http://airflow;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $host;
                
                proxy_redirect off;
                proxy_buffering off;
                
                # CRITIQUE: Intercepte les erreurs
                proxy_intercept_errors on;
                
                # Timeouts
                proxy_read_timeout {{ .Values.nginx.prelogin.proxyTimeout | default "300s" }};
                proxy_connect_timeout 75s;
            }
        }
    }

  index.html: |
    <!DOCTYPE html>
    <html lang="{{ .Values.nginx.prelogin.language | default "fr" }}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ .Values.nginx.prelogin.title | default "Apache Airflow - Authentification" }}</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: {{ .Values.nginx.prelogin.backgroundColor | default "linear-gradient(135deg, #017CEE 0%, #764ba2 100%)" }};
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .container {
                background: white;
                border-radius: 20px;
                padding: 60px 80px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 500px;
            }
            .logo {
                font-size: 64px;
                margin-bottom: 20px;
            }
            h1 {
                font-size: 32px;
                color: #1a1a1a;
                margin-bottom: 10px;
            }
            .subtitle {
                font-size: 16px;
                color: #666;
                margin-bottom: 40px;
            }
            .login-btn {
                background: {{ .Values.nginx.prelogin.buttonColor | default "linear-gradient(135deg, #017CEE 0%, #764ba2 100%)" }};
                color: white;
                border: none;
                padding: 16px 50px;
                font-size: 18px;
                font-weight: 600;
                border-radius: 50px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 15px rgba(1, 124, 238, 0.3);
            }
            .login-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(1, 124, 238, 0.4);
            }
            .security-note {
                margin-top: 30px;
                font-size: 14px;
                color: #999;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="logo">{{ .Values.nginx.prelogin.logo | default "ðŸš€" }}</div>
            <h1>{{ .Values.nginx.prelogin.heading | default "Apache Airflow" }}</h1>
            <p class="subtitle">{{ .Values.nginx.prelogin.subtitle | default "Plateforme de Data Orchestration" }}</p>
            
            <a href="/login" class="login-btn">
                {{ .Values.nginx.prelogin.buttonText | default "Se connecter via SSO" }}
            </a>
            
            <p class="security-note">
                {{ .Values.nginx.prelogin.securityNote | default "ðŸ”’ Authentification sÃ©curisÃ©e via Keycloak" }}
            </p>
        </div>
    </body>
    </html>
{{- end }}
