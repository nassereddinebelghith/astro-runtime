# ============================================================================

# FICHIER 1: plugins/welcome_page_plugin.py

# Page dâ€™accueil publique avec redirection vers /login pour authentification

# ============================================================================

import os
from airflow.plugins_manager import AirflowPlugin
from flask import Blueprint, render_template_string, redirect

# Blueprint pour la page welcome (publique)

welcome_bp = Blueprint(
â€œwelcome_pageâ€,
**name**,
template_folder=â€˜templatesâ€™,
static_folder=â€˜staticâ€™
)

@welcome_bp.route(â€™/welcomeâ€™)
def welcome():
â€œâ€â€œPage dâ€™accueil publique avant authentificationâ€â€â€
version = os.environ.get(â€˜VERSIONâ€™, â€˜Unknownâ€™)

```
html = """
<!DOCTYPE html>
<html>
<head>
    <title>Bienvenue sur Airflow</title>
    <meta charset="UTF-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 60px 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #718096;
            font-size: 16px;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .version {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            color: #4a5568;
            font-size: 15px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸš€</div>
        <h1>Sign In</h1>
        <p class="subtitle">
            Bienvenue sur la plateforme de donnÃ©es Airflow.<br>
            Cliquez ci-dessous pour vous authentifier.
        </p>
        <button onclick="window.location.href='/login'">
            Se connecter
        </button>
        <div class="version">
            DataHUB OaaS v{{ version }}
        </div>
    </div>
</body>
</html>
"""
return render_template_string(html, version=version)
```

class WelcomePagePlugin(AirflowPlugin):
name = â€œwelcome_pageâ€
flask_blueprints = [welcome_bp]

```
@staticmethod
def on_load(app):
    """Rediriger la racine / vers /welcome"""
    @app.route('/')
    def index_redirect():
        return redirect('/welcome')
```

# ============================================================================

# FICHIER 2: plugins/keycloak_auth_manager.py (MODIFICATIONS Ã€ FAIRE)

# Ton Auth Manager custom avec les overrides pour autoriser /welcome

# ============================================================================

â€œâ€â€
EXEMPLE DE TON AUTH MANAGER AVEC LES MODIFICATIONS NÃ‰CESSAIRES

Si tu as dÃ©jÃ  un fichier keycloak_auth_manager.py, ajoute ces mÃ©thodes.
Sinon, voici un exemple complet :
â€œâ€â€

from airflow.auth.managers.fab.fab_auth_manager import FabAuthManager
from flask import request
from flask_login import current_user

class KeycloakAuthManager(FabAuthManager):
â€œâ€â€
Custom Auth Manager pour Keycloak OIDC avec support de page publique /welcome
â€œâ€â€

```
def is_logged_in(self) -> bool:
    """
    Override pour permettre l'accÃ¨s Ã  certaines routes publiques sans login
    """
    # Routes publiques accessibles sans authentification
    public_paths = ['/welcome', '/', '/static']
    
    # VÃ©rifier si on est sur une route publique
    if any(request.path.startswith(path) for path in public_paths):
        return True
    
    # Pour toutes les autres routes, vÃ©rifier l'authentification normalement
    return super().is_logged_in()

def is_authorized_view(self, access_view: str) -> bool:
    """
    Autoriser certaines vues sans authentification
    """
    # Vues publiques
    public_views = [
        'welcome_page.welcome',
        'index_redirect',
        'Airflow.login',
        'AuthOAuthView.oauth_authorized'
    ]
    
    if access_view in public_views:
        return True
    
    return super().is_authorized_view(access_view)

# Le reste de ton implÃ©mentation Keycloak reste inchangÃ©
# (get_url_login, oauth config, etc.)
```

# ============================================================================

# FICHIER 3: airflow.cfg OU variables dâ€™environnement

# Configuration nÃ©cessaire pour Airflow 3.1.4

# ============================================================================

â€œâ€â€
Dans ton airflow.cfg ou via variables dâ€™environnement Astronomer:

[core]
auth_manager = plugins.keycloak_auth_manager.KeycloakAuthManager

[webserver]
update_fab_perms = True
expose_config = True

OU via variables dâ€™environnement dans values.yaml Astronomer:

airflow:
config:
AIRFLOW__CORE__AUTH_MANAGER: plugins.keycloak_auth_manager.KeycloakAuthManager
AIRFLOW__WEBSERVER__UPDATE_FAB_PERMS: â€œTrueâ€

extraEnv:
- name: VERSION
value: â€œ3.1.4â€
â€œâ€â€

# ============================================================================

# DÃ‰PLOIEMENT SUR ASTRONOMER

# ============================================================================

â€œâ€â€
Structure de ton projet:

your-airflow-project/
â”œâ”€â”€ dags/
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ welcome_page_plugin.py          # Le plugin avec la page welcome
â”‚   â””â”€â”€ keycloak_auth_manager.py        # Ton Auth Manager modifiÃ©
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ packages.txt
â”œâ”€â”€ requirements.txt
â””â”€â”€ airflow_settings.yaml (optionnel)

Dans values.yaml ou via lâ€™UI Astronomer, ajoute:

env:

- name: VERSION
  value: â€œ3.1.4â€
- name: AIRFLOW__CORE__AUTH_MANAGER
  value: â€œplugins.keycloak_auth_manager.KeycloakAuthManagerâ€

Ensuite:

1. astro dev restart (en local)
1. astro deploy (en production)
   â€œâ€â€

# ============================================================================

# FLOW Dâ€™AUTHENTIFICATION

# ============================================================================

â€œâ€â€
AVANT (sans welcome page):
User accÃ¨de Ã  https://airflow.example.com
â†’ RedirigÃ© vers Keycloak
â†’ Login Keycloak
â†’ Retour sur /home Airflow

APRÃˆS (avec welcome page):
User accÃ¨de Ã  https://airflow.example.com
â†’ RedirigÃ© vers /welcome (PAGE PUBLIQUE)
â†’ User clique â€œSe connecterâ€
â†’ RedirigÃ© vers /login qui dÃ©clenche Keycloak OIDC
â†’ Login Keycloak
â†’ Retour sur /home Airflow
â€œâ€â€

# ============================================================================

# NOTES IMPORTANTES

# ============================================================================

â€œâ€â€

1. La route /welcome DOIT Ãªtre publique (pas dâ€™auth requise)
1. Le bouton â€œSe connecterâ€ pointe vers /login (route Airflow standard)
1. /login dÃ©clenche automatiquement ton flow Keycloak OIDC
1. AprÃ¨s auth rÃ©ussie, Keycloak redirige vers /home
1. La version est rÃ©cupÃ©rÃ©e depuis os.environ.get(â€˜VERSIONâ€™)

DÃ‰PANNAGE:

- Si tu vois un 401 Unauthorized sur /welcome:
  â†’ VÃ©rifie que is_logged_in() retourne True pour /welcome
  â†’ VÃ©rifie que ton Auth Manager est bien chargÃ©
- Si la redirection / vers /welcome ne fonctionne pas:
  â†’ VÃ©rifie les logs du webserver
  â†’ Assure-toi que le plugin est bien dans le dossier plugins/
- Pour tester en local:
  astro dev logs -f webserver
  Puis accÃ¨de Ã  http://localhost:8080
  â€œâ€â€